{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/hongdahui/Downloads/notion-database-invoices/app/api/records/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\n\nexport async function GET() {\n  try {\n    const misoUrl = process.env.MISO_URL\n    const misoKey = process.env.MISO_KEY\n\n    if (!misoUrl || !misoKey) {\n      console.log(\"Missing credentials\")\n      return NextResponse.json(\n        { error: \"MISO 인증 정보가 설정되지 않았습니다. 환경변수를 확인해주세요.\" },\n        { status: 500 },\n      )\n    }\n\n    const apiEndpoint = `${misoUrl}/workflows/run`\n\n    const requestBody = {\n      inputs: {},\n      mode: \"blocking\",\n      user: \"invoice-generator\",\n    }\n\n    const response = await fetch(apiEndpoint, {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${misoKey}`,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(requestBody),\n      cache: \"no-store\",\n    })\n\n\n    if (!response.ok) {\n      const errorData = await response.json().catch(() => ({}))\n      console.log(\"Error response:\", errorData)\n\n      let errorMessage = \"MISO API 호출에 실패했습니다.\"\n      if (errorData.detail) {\n        errorMessage = `오류: ${errorData.detail}`\n      } else if (response.status === 400) {\n        errorMessage = \"잘못된 요청입니다. 워크플로우가 발행되었는지 확인해주세요.\"\n      } else if (response.status === 401) {\n        errorMessage = \"인증에 실패했습니다. API 키를 확인해주세요.\"\n      } else if (response.status === 500) {\n        errorMessage = \"서버 내부 오류가 발생했습니다.\"\n      }\n\n      return NextResponse.json(\n        { error: errorMessage, status: response.status, detail: errorData },\n        { status: response.status },\n      )\n    }\n\n    const data = await response.json()\n    console.log(\"MISO API response structure:\", {\n      hasData: !!data.data,\n      hasOutputs: !!data.data?.outputs,\n      hasResults: !!data.data?.outputs?.[\"결과\"],\n      outputsKeys: data.data?.outputs ? Object.keys(data.data.outputs) : [],\n    })\n\n    if (data.data && data.data.outputs && data.data.outputs[\"결과\"]) {\n      const results = data.data.outputs[\"결과\"]\n\n      let parsedResults = results\n\n      if (typeof results === \"string\") {\n        // Remove markdown code block markers (```javascript, ```python, etc.)\n        let cleanedString = results.trim()\n        cleanedString = cleanedString.replace(/^```\\w*\\n?/g, \"\")\n        cleanedString = cleanedString.replace(/\\n?```$/g, \"\")\n        cleanedString = cleanedString.trim()\n\n        // Replace Python None with null for proper JSON parsing\n        cleanedString = cleanedString.replace(/:\\s*None/g, \": null\")\n\n        try {\n          const parsed = JSON.parse(cleanedString)\n\n          // Extract the actual array from parsed.outputs.결과\n          if (parsed.outputs && parsed.outputs[\"결과\"]) {\n            parsedResults = parsed.outputs[\"결과\"]\n          } else if (Array.isArray(parsed)) {\n            // If the parsed result is directly an array\n            parsedResults = parsed\n          } else {\n            // If the parsed result is the object itself\n            parsedResults = parsed\n          }\n        } catch (parseError) {\n          console.error(\"Failed to parse string:\", parseError)\n          console.error(\"Cleaned string:\", cleanedString)\n          return NextResponse.json([])\n        }\n      }\n\n      if (Array.isArray(parsedResults)) {\n        console.log(`Found array with ${parsedResults.length} records`)\n        console.log(\"First record keys:\", parsedResults.length > 0 ? Object.keys(parsedResults[0]) : \"No records\")\n        console.log(\"First record data:\", parsedResults.length > 0 ? parsedResults[0] : \"No records\")\n\n        const records = parsedResults.map((item: any, index: number) => {\n          return {\n            id: String(index + 1),\n            company: item[\"회사명\"] ?? \"\",\n            amount: item[\"최종금액\"] != null ? Number(item[\"최종금액\"]) : 0,\n            contactName: item[\"담당자\"] ?? \"\",\n            contactEmail: item[\"담당자 이메일\"] ?? \"\",\n            issueDate: item[\"발행일\"] ?? \"\",\n            description: item[\"설명\"] ?? \"\",\n          }\n        })\n\n        console.log(`Successfully parsed ${records.length} records`)\n        return NextResponse.json(records)\n      }\n    }\n\n    console.log(\"No valid data structure found in MISO response\")\n    return NextResponse.json([])\n  } catch (error) {\n    console.error(\"Failed to fetch records:\", error)\n    return NextResponse.json({ error: \"MISO API 연결에 실패했습니다. 네트워크 연결을 확인해주세요.\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}